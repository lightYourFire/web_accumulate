(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{201:function(t,s,e){"use strict";e.r(s);var n=e(0),a=Object(n.a)({},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),e("p",[t._v("有一个任务非常耗时会消耗后台大量算力，所以在退出页面的时候，要求前端这边发送一个请求来杀死任务。")]),t._v(" "),e("p",[t._v("一开始以为这个需求非常简单，就是在进入其他路由前，发送一下请求，杀死 \b 一下任务就好了。")]),t._v(" "),e("p",[t._v("然而现实狠狠的打了我的脸，因为退出页面的场景不止切换路由~")]),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),t._m(11),t._v(" "),t._m(12),t._v(" "),e("p",[t._v("在 chrome 下长这个样子，你们肯定都见过：")]),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._m(17),t._v(" "),e("p",[t._v("以下行为是基于 chorme：")]),t._v(" "),t._m(18),t._v(" "),t._m(19),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),e("p",[t._v("现在大部分浏览器都不允许修改弹窗的标题，这个是为了安全考虑，来保证用户不受到错误信息的误导，")]),t._v(" "),t._m(22),t._v(" "),e("p",[t._v("一开始我以为既然可以拦截到用户的刷新/关闭页面的操作，出现了上面那个弹窗，这个需求就已经做完了的时候。")]),t._v(" "),t._m(23),t._v(" "),t._m(24),t._v(" "),t._m(25),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),e("p",[t._v("当页面正在被卸载的时候触发该事件，该事件不可取消，为不可逆操作。")]),t._v(" "),t._m(28),t._v(" "),e("p",[t._v("直接监听该事件就可以了。")]),t._v(" "),t._m(29),t._m(30),t._v(" "),t._m(31),t._v(" "),t._m(32),e("p",[t._v("到这里大家肯定以为已经做出来了该需求，事实上，并没有！")]),t._v(" "),t._m(33),t._v(" "),t._m(34),t._v(" "),t._m(35),t._v(" "),t._m(36),t._v(" "),e("p",[e("strong",[t._v("最后使用原生的"),e("a",{attrs:{href:"http://www.w3school.com.cn/xml/xml_http.asp",target:"_blank",rel:"noopener noreferrer"}},[t._v("XMLHttpRequest"),e("OutboundLink")],1),t._v("对象")]),t._v("，让请求同步")]),t._v(" "),e("p",[t._v("大功告成！")]),t._v(" "),t._m(37),t._v(" "),e("p",[t._v("在这两个API中,还有些事项需要注意：")]),t._v(" "),t._m(38),t._v(" "),t._m(39),t._v(" "),e("p",[t._v("觉得还不错的话，给我的项目点个"),e("a",{attrs:{href:"https://github.com/OBKoro1/Brush_algorithm",target:"_blank",rel:"noopener noreferrer"}},[t._v("star"),e("OutboundLink")],1),t._v("吧")]),t._v(" "),e("p",[e("a",{attrs:{href:"http://obkoro1.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("博客"),e("OutboundLink")],1),t._v("、"),e("a",{attrs:{href:"https://github.com/OBKoro1/Brush_algorithm",target:"_blank",rel:"noopener noreferrer"}},[t._v("前端算法"),e("OutboundLink")],1),t._v("、"),e("a",{attrs:{href:"https://user-gold-cdn.xitu.io/2018/5/1/1631b6f52f7e7015?w=344&h=344&f=jpeg&s=8317",target:"_blank",rel:"noopener noreferrer"}},[t._v("公众号"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("以上2019.1.13")])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"刷新-关闭页面之前发送请求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#刷新-关闭页面之前发送请求","aria-hidden":"true"}},[this._v("#")]),this._v(" 刷新/关闭页面之前发送请求")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"背景："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#背景：","aria-hidden":"true"}},[this._v("#")]),this._v(" 背景：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"退出页面场景："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#退出页面场景：","aria-hidden":"true"}},[this._v("#")]),this._v(" 退出页面场景：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("还在本网站，跳到其他路由")]),this._v(" "),s("li",[this._v("刷新页面/关闭页面")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"还在本网站，跳到其他路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#还在本网站，跳到其他路由","aria-hidden":"true"}},[this._v("#")]),this._v(" 还在本网站，跳到其他路由")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这个比较简单，在"),s("code",[this._v("Vue")]),this._v("中可以通过路由离开的钩子"),s("code",[this._v("beforeRouteLeave")]),this._v("来实现：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeRouteLeave")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("任务运行中"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送请求")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用户离开")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("刷新页面/关闭页面的情况：")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("然而在刷新页面的时候，"),s("code",[this._v("beforeRouteLeave")]),this._v("并不会执行，接着想到了下面这两个"),s("code",[this._v("API")]),this._v(".")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"beforeunload和unload"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#beforeunload和unload","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("beforeunload")]),this._v("和"),s("code",[this._v("unload")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"beforeunload-当浏览器窗口关闭或者刷新时触发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#beforeunload-当浏览器窗口关闭或者刷新时触发","aria-hidden":"true"}},[this._v("#")]),this._v(" beforeunload 当浏览器窗口关闭或者刷新时触发:")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("介绍")]),this._v("：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用这个"),s("code",[this._v("API")]),this._v("可以阻止页面直接关闭，用户通过点击确定/取消按钮，来决定是否不关闭/刷新当前页面。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"http://ww1.sinaimg.cn/large/005Y4rCogy1fyr8kpadj0j30bt04vglt.jpg",alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("如何使用")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这个 API 的使用非常简单，只要在页面加载的时候监听一下此事件，在需要出现弹窗的时候"),s("strong",[this._v("return 一个可以转化为 true 的值")]),this._v(",就可以了。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 页面卸载之前")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否杀死任务")]),t._v("\nwindow"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onbeforeunload")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" e "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("任务运行 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" 对应页面"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'您可能有数据没有保存'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在部分浏览器可以修改弹窗标题")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 没有return一个可以转化为true的值 就不会出现弹窗")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("出现此弹窗的浏览器行为")]),this._v("：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ol",[e("li",[e("p",[t._v("焦点：你没有点击取消/确定之前，焦点会一直在此弹窗上")])]),t._v(" "),e("li",[e("p",[t._v("你无法在出现弹窗的页面上执行任何操作")])]),t._v(" "),e("li",[e("p",[t._v("在其他页面也只能执行简单的点击操作，弹窗还是存在页面中间，无法使用键盘，")])]),t._v(" "),e("li",[e("p",[t._v("键盘：键盘被绑定在弹窗上，只能通过按键"),e("code",[t._v("Esc")]),t._v("、"),e("code",[t._v("Enter")]),t._v("来执行取消/确定操作")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("弹窗不是页面的 dom，是浏览器的行为")])])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("用户取消/确定，没有回调 API，无法得知")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("弹窗标题")]),this._v("：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("chrome 中刷新页面的标题："),s("code",[this._v("重新加载此网站?")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("chrome 中关闭页面的标题："),s("code",[this._v("离开此网站?")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("迷茫")]),this._v("：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("然后发现，"),s("strong",[this._v("浏览器竟然没有提供用户点击确定/取消刷新页面的回调")]),this._v("。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("p",[t._v("到这里我陷入了迷茫，盯着"),e("code",[t._v("beforeunload")]),t._v("这个 API 思考了起了人生的意义(其实是在发呆)，盯着盯着，从"),e("code",[t._v("beforeunload")]),t._v("的"),e("code",[t._v("before")]),t._v("我也就想到了"),e("code",[t._v("unload")]),t._v("这个 API。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("瞬间又燃起了斗志，何不试试这个"),s("code",[this._v("unload")]),this._v("？")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"unload当页面正在被卸载的时候触发该事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#unload当页面正在被卸载的时候触发该事件","aria-hidden":"true"}},[this._v("#")]),this._v(" "),s("code",[this._v("unload")]),this._v("当页面正在被卸载的时候触发该事件")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("介绍")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("使用")])])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onunload")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" e "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("结合需求")]),this._v(":")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("code",[this._v("killTask")]),this._v("为"),s("code",[this._v("beforeunload")]),this._v("时定义的变量，每次进入回调，都会给"),s("code",[this._v("killTask")]),this._v("赋值，使用这个值就可以判断什么时候可以发送请求杀死任务。")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"language-js line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("window"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onunload")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" e "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("killTask "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" 对应页面"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// \b发送请求")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("无法发送异步请求")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("\b\b我使用的是"),s("code",[this._v("axios")]),this._v("来发送请求，请求发出去了，但是被取消了，服务器那边根本没有收到请求，如下。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"http://ww1.sinaimg.cn/large/005Y4rCogy1fz5098m4tsj31gd06n761.jpg",alt:""}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("经过一顿分析:发现是"),s("code",[this._v("axios")]),this._v("请求是异步的问题，谷歌之后发现axios不支持同步的请求")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"小结："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#小结：","aria-hidden":"true"}},[this._v("#")]),this._v(" 小结：")])},function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ol",[e("li",[e("p",[e("code",[t._v("alert")]),t._v("/"),e("code",[t._v("confirm")]),t._v("/"),e("code",[t._v("debugger")]),t._v("/"),e("code",[t._v("window.open")]),t._v("等都无法使用")])]),t._v(" "),e("li",[e("p",[t._v("抛出错误无法终止这两个API")])]),t._v(" "),e("li",[e("p",[t._v("谨慎使用异步")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"鼓励我一下："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#鼓励我一下：","aria-hidden":"true"}},[this._v("#")]),this._v(" 鼓励我一下：")])}],!1,null,null,null);a.options.__file="退出页面发送请求.md";s.default=a.exports}}]);